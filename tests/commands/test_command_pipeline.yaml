---
- id: pipeline_ateco-2025
  marks:
  - asset
  description: |-
    TODO
  steps:
  - description: |-
      Given:
      - a TTL file
      - a JSON-LD frame

      When:
      - I execute the `jsonld create` command
      - I execute the `datapackage create` command
      - I execute the `csv create` command

      Then:
      - all commands exit successfully
      - the output CSV file contains 3257 items
    command:
    - jsonld
    - create
    - --ttl
    - assets/controlled-vocabularies/ateco-2025/ateco-2025.ttl
    - --frame
    - assets/controlled-vocabularies/ateco-2025/ateco-2025.frame.yamlld
    - --vocabulary-uri
    - https://w3id.org/italia/stat/controlled-vocabulary/economy/ateco-2025
    - --batch-size
    - "1000"
    - --frame-only
    - --output
    - tests/data/snapshots/ateco-2025/ateco-2025.data.yamlld
    - --force
    expected:
      files:
      - path: tests/data/snapshots/ateco-2025/ateco-2025.data.yamlld
        snapshot: tests/data/snapshots/ateco-2025/ateco-2025.data.yamlld
        compare: data
      logs:
      - >-
        Dataset contains 3345 items, processing in batches of
        1000
      - >-
        Batched framing completed, total items: 3257
  - command:
    - jsonld
    - validate
    - --vocabulary-uri
    - https://w3id.org/italia/stat/controlled-vocabulary/economy/ateco-2025
    - --ttl
    - assets/controlled-vocabularies/ateco-2025/ateco-2025.ttl
    - --jsonld
    - tests/data/snapshots/ateco-2025/ateco-2025.data.yamlld
    expected: {}
  - description: |-
      When:
      - I run `datapackage create`

      Then:
      - the command exits successfully
      - a datapackage stub YAML file is created
      - logs show the datapackage stub was created
    command:
    - datapackage
    - create
    - --ttl
    - assets/controlled-vocabularies/ateco-2025/ateco-2025.ttl
    - --frame
    - assets/controlled-vocabularies/ateco-2025/ateco-2025.frame.yamlld
    - --vocabulary-uri
    - https://w3id.org/italia/stat/controlled-vocabulary/economy/ateco-2025
    - --output
    - tests/data/snapshots/ateco-2025/ateco-2025-datapackage.yaml
    - --force
    expected:
      files:
      - path: tests/data/snapshots/ateco-2025/ateco-2025-datapackage.yaml
        snapshot: tests/data/snapshots/ateco-2025/ateco-2025-datapackage.yaml
        compare: data
      logs:
      - >-
        Datapackage stub created: .*tests/data/snapshots/ateco-2025/ateco-2025-datapackage.yaml
      stdout:
      - >-
        Creating datapackage metadata for https://w3id.org/italia/stat/controlled-vocabulary/economy/ateco-2025
      - >-
        ✓ Created: .*tests/data/snapshots/ateco-2025/ateco-2025-datapackage.yaml
  - description: |-
      When:
      - I run `datapackage validate` on the created datapackage stub

      Then:
      - the command exits successfully
      - validation passes
    command:
    - datapackage
    - validate
    - --datapackage
    - tests/data/snapshots/ateco-2025/ateco-2025-datapackage.yaml
    expected:
      stdout:
      - >-
        ✓ Datapackage validation passed
  - description: |-
      When:
      - I run the `csv create` command

      Then:
      - the command exits successfully
      - the output CSV file contains the expected items
    command:
    - csv
    - create
    - --datapackage
    - tests/data/snapshots/ateco-2025/ateco-2025-datapackage.yaml
    - --jsonld
    - tests/data/snapshots/ateco-2025/ateco-2025.data.yamlld
    - --output
    - tests/data/snapshots/ateco-2025/ateco-2025.csv
    - --force
    expected:
      files:
      - path: tests/data/snapshots/ateco-2025/ateco-2025.csv
        snapshot: tests/data/snapshots/ateco-2025/ateco-2025.csv
      logs:
      - >-
        CSV file created successfully at .*ateco-2025.csv
      stdout:
      - >-
        Created: .*/ateco-2025.csv
  - description: |-
      When:
      - I run `csv validate` on the created CSV file

      Then:
      - the command exits successfully
      - validation passes
    command:
    - csv
    - validate
    - --vocabulary-uri
    - https://w3id.org/italia/stat/controlled-vocabulary/economy/ateco-2025
    - --ttl
    - assets/controlled-vocabularies/ateco-2025/ateco-2025.ttl
    - --datapackage
    - tests/data/snapshots/ateco-2025/ateco-2025-datapackage.yaml
    expected:
      logs:
      - >-
        Vocabulary URI https://w3id.org/italia/stat/controlled-vocabulary/economy/ateco-2025
        found in original RDF graph
      - >-
        CSV-derived RDF graph has 16285 triples
      stdout:
      - >-
        CSV roundtrip validation passed with 3257 rows and 16285
        triples
