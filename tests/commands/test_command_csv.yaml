---
- id: create_csv_ateco-2025
  marks:
  - asset
  description: |-
    TODO
  steps:
  - description: |-
      When:
      - I run the `csv create` command

      Then:
      - the command exits successfully
      - the output CSV file contains the expected items
    command:
    - csv
    - create
    - --datapackage
    - tests/data/snapshots/ateco-2025/ateco-2025-datapackage.yaml
    - --jsonld
    - tests/data/snapshots/ateco-2025/ateco-2025.data.yamlld
    - --output
    - tests/data/snapshots/ateco-2025/ateco-2025.csv
    expected:
      files:
      - path: tests/data/snapshots/ateco-2025/ateco-2025.csv
        snapshot: tests/data/snapshots/ateco-2025/ateco-2025.csv
        compare: data
      logs:
      - >-
        Dataset contains 3345 items, processing in batches of
        1000
      - >-
        CSV file created successfully at .*ateco-2025.csv
- id: csv_create_validate_agente_causale
  marks:
  - asset
  description: |-
    Given:
    - a TTL file
    - a JSON-LD data snapshot
    - a datapackage.yaml

    When:
    - I run `csv validate`

    Then:
    - the command exits successfully
  steps:
  - command:
    - csv
    - create
    - --jsonld
    - tests/data/snapshots/agente_causale/agente_causale.data.yamlld
    - --datapackage
    - tests/data/snapshots/agente_causale/agente_causale-datapackage.yaml
    - --output
    - tests/data/snapshots/agente_causale/agente_causale.csv
    expected:
      files:
      - path: tests/data/snapshots/agente_causale/agente_causale.csv
        snapshot: tests/data/snapshots/agente_causale/agente_causale.csv
        compare: data
  - command:
    - csv
    - validate
    - --vocabulary-uri
    - https://w3id.org/italia/work-accident/controlled-vocabulary/adm_serv/agente_causale
    # Arguments
    - --ttl
    - assets/controlled-vocabularies/agente_causale/latest/agente_causale.ttl
    - --datapackage
    - tests/data/snapshots/agente_causale/agente_causale-datapackage.yaml
    expected:
      logs:
      - >-
        INFO CSV data loaded and validated successfully
      - >-
        Original RDF graph loaded with 32228 triples
      stdout:
      - >-
        CSV roundtrip validation passed with 2922 rows and 8766
        triples
#
# Not supported for now
#
- id: csv_create_validate_currency
  marks:
  - asset
  description: |-
    Given:
    - a TTL file
    - a JSON-LD data snapshot
    - a datapackage.yaml

    When:
    - I run `csv create`

    Then:
    - the command exits successfully
    - the output JSON-LD file contains 179 items

    When:
    - I run `csv validate`

    Then:
    - the command exits successfully
  skip: true
  steps:
  - command:
    - csv
    - create
    - --vocabulary-uri
    - http://publications.europa.eu/resource/authority/currency
    # Arguments
    - --ttl
    - tests/data/currency.ttl
    - --jsonld
    - tests/data/snapshots/currency.data.yamlld
    - --output
    - tests/data/snapshots/tmp-currency.data.yamlld
    expected:
      logs:
      - >-
        Dataset contains 286 items, processing without batching
      - >-
        Batched framing completed, total items: 179
      files:
      - path: tests/data/snapshots/tmp-currency.data.yamlld
        snapshot: tests/data/snapshots/currency.data.yamlld
  - command:
    - csv
    - validate
    - --vocabulary-uri
    - http://publications.europa.eu/resource/authority/currency
    # Arguments
    - --ttl
    - tests/data/currency.ttl
    - --datapackage
    - tests/data/snapshots/currency/datapackage.yaml
    expected:
      logs:
      - >-
        Vocabulary URI http://publications.europa.eu/resource/authority/currency
        found in original RDF graph
      - >-
        Framed JSON-LD graph has 1074 triples
      stdout:
      - >-
        JSON-LD validation passed
